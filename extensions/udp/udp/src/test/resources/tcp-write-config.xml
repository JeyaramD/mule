<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:tcp="http://www.mulesoft.org/schema/mule/tcp"
      xmlns="http://www.mulesoft.org/schema/mule/core"
      xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
      http://www.mulesoft.org/schema/mule/tcp http://www.mulesoft.org/schema/mule/tcp/current/mule-tcp.xsd">

    <tcp:requester-config name="requester">
        <tcp:requester-connection host="localhost" port="8006"/>
        <tcp:protocol>
            <tcp:length-protocol maxMessageLength="512" payloadOnly="true"/>
        </tcp:protocol>
    </tcp:requester-config>

    <tcp:listener-config name="listener">
        <tcp:listener-connection host="localhost" port="8005"/>
        <tcp:protocol>
            <tcp:safe-protocol rethrowExceptionOnRead="true"/>
        </tcp:protocol>
    </tcp:listener-config>

    <flow name="write">
        <set-payload value="test string"/>
        <tcp:write config-ref="requester"/>
    </flow>

    <flow name="listen">
        <tcp:listener config-ref="listener"/>
        <flow-ref name="onIncomingConnection"/>
    </flow>

    <sub-flow name="onIncomingConnection">
        <expression-component>org.mule.extension.tcp.TcpWriteTestCase.onIncomingConnection(message)
        </expression-component>
    </sub-flow>

</mule>
